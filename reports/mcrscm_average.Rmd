---
title: MCRSCM simulation results
author: "Dániel Vörös"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: false
params:
  cache.path:
    label: Set path of cache folder
    value: report_cache/
  dir:
    label: Path to data dir
    value: "/home/danielred/data/programs/mcrs_to_scm/OUT/"
  ssh:
    label: SSH address in format of user@domain:port
    value: ""
  ssh_key:
    label: Location of ssh public key
    value: ~/.ssh/id_rsa
  force:
    label: To force the document to regenerate all its plots
    value: FALSE
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=FALSE, message=F}
#params <- list(cache.path="report_cache/", dir="/home/danielred/data/programs/mcrs_to_scm/OUT/", )

message("\ncache.path: ", params$cache.path,
        "\ndir: ", params$dir, 
        "\nssh: ", params$ssh, 
        "\nssh_key: ", params$ssh_key )
#rootdir="/home/danielred/data/programs/mcrs_chromosome/OUT/"

# set this option in the first code chunk in the document
knitr::opts_chunk$set(echo = F, cache.path=params$cache.path, cache.lazy = FALSE )

# libraries
library(RColorBrewer)
library(ggplot2)
library(tidyr)
library(gganimate)
library(lattice)
library(scales)
library(knitr)
library(Polychrome)
library(cowplot)
library(dplyr)

par.orig <- par(no.readonly = T) # save default parameters

# workdir <- ifelse(as.logical(params$ssh),
#                   paste0(params$ssh_dir, "/", whattosee, "/"),
#                   paste0(rootdir, whattosee, "/"))

ssh <- ifelse(nchar(params$ssh)==0, NA, params$ssh)

```

```{r functions, cache=T}
################
## Functions ###
################

get_remote <- function(address, 
                        path="data/programs/mcrs_chromosome/OUT", 
                        path2="", 
                        key= "~/.ssh/id_rsa",
                        what="all",
                        fullpath=F    
                       ){
  if(!what %in% c("all", "dirs", "files")){
    return(-2)
  }
  
  try({
    #connect to remote host
    if(class(address) == "ssh_session"){
      con = address
      dest = F
    } else {
      con <- ssh_connect(address, keyfile = key)
      dest = T
    }
    
    
    #get data
    if(!ssh_session_info(con)$connected){
      return(-1)
    }
    if(what == "all") {
        out <- ssh_exec_internal(con, command=paste("cd", paste0(path, path2), "\nls -p"))
    } else if(what=="dirs"){
        out <- ssh_exec_internal(con, command=paste("cd", paste0(path, path2), "\nls -d */"))
    } else {
        out <- ssh_exec_internal(con, command=paste("cd", paste0(path, path2), "\nls -p | grep -v /"))
    }
    
    #disconnect
    if(dest) ssh_disconnect(con)
    
    #return data
    if(fullpath){
      return( paste( 
        paste0(path, path2), 
        ( rawToChar(out$stdout) |> strsplit("\\n") )[[1]], 
        sep="/")
      )
    } else {
      return(( rawToChar(out$stdout) |> strsplit("\\n") )[[1]])
    }
  })
  
  return(-3)
}

get_remote_dirs <- function(address, ...) get_remote(address=address, what = "dirs", ...)

get_remote_files <- function(address, pattern=NA, ...) {
  out <- get_remote(address=address, what = "files", ...)
  if(is.na(pattern)) {
    return(out)
  }
  return( grep(pattern, out, value = T) )
}

sshready_adr <- function(orig){
  unlist(lapply(strsplit(orig, ":"), function(x) paste(x, collapse=" -p ")))
}

get_file <- function(target, path="~/", ssh=NA, ssh_key="~/.ssh/id_rsa", fast=T, to=NA){
  if(is.na(ssh)){
    file = paste(path, 
               target, 
               sep=ifelse(nchar(path) > 0 & substr(path, nchar(path), nchar(path)) != "/", "/", ""))
    if( all(file.exists(file)) ) return(file)
    else return(NA)
  } else try({ 
    #it is in shh
    
    #check output dir
    if(is.na(to)) {
      to = tempdir()
    } else {
      if(!dir.exists(to)){
        if(!dir.create(to)) {
          warning(paste("Cannot create dir", to))
          return(NA)
        }
      }
    }
    
    #download
    tofile = paste(to, target, sep=ifelse(nchar(to) > 0 & substr(to, nchar(to), nchar(to)) != "/", "/", ""))
    if(fast){
      system(paste("ssh", sshready_adr(ssh), '"tar -C', path, '-zc', target, '" | tar zx -C', to))
      if(all(file.exists( tofile ))){
        return( tofile )
      } else {
        warning(paste("Could not download file tru shh", target))
        return(NA)
      }
    } else {
      #connecting to ssh
      ssh_con <- ssh_connect(ssh, keyfile = ssh_key)
      if(!ssh_session_info(ssh_con)$connected){
        warning("Could not establish shh connection")
        return(NA)
      }
      #download
      scp_download(ssh_con, 
                   files= paste(path, target, sep=ifelse(nchar(path) > 0 & substr(path, nchar(path), nchar(path)) != "/", "/", "")),
                   to=to
                   )
      #disconnect
      ssh_disconnect(ssh_con)
      return( tofile )
    }
  })
}

get_mtime <- Vectorize(function(target, path="~/", ssh=NA, ssh_key="~/.ssh/id_rsa"){
  file = paste(path, 
               target, 
               sep=ifelse(nchar(path) > 0 & substr(path, nchar(path), nchar(path)) != "/", "/", ""))
  
  if(is.na(ssh)){ #local file
    if( all(file.exists( file )) ){
      return( system(paste("stat -c %y", file), intern=T) )
    } else {
      return(NA)
    }
  } else try({ 
  #it is in shh
  #connecting to ssh
  ssh_con <- ssh_connect(ssh, keyfile = ssh_key)
  if(!ssh_session_info(ssh_con)$connected){
    warning("Could not establish shh connection")
    return(NA)
  }
  
  #download
  type <- capture.output(ssh_exec_wait(ssh_con, paste0("tf=", 
                                                       file, 
                                                       ";if [ -f $tf ]; then echo file; else if [ -d $tf ]; then echo dir; else echo FALSE; fi; fi") 
                                       ))[1]
  if(!type %in% c("file", "dir")) return(NA)
  
  out <- capture.output(ssh_exec_wait(ssh_con, paste("stat -c %y", file)))[1]
  #disconnect
  ssh_disconnect(ssh_con)
  return(out)
  
  })
})

get_cached_files <- function(needed_files, path="./", ssh=NA, ssh_key="~/.ssh/id_rsa"){
  lapply(needed_files, function(file) {
      hash <- get_mtime(needed_files, path=params$dir, ssh=ssh, ssh_key=params$ssh_key)
      if(is.na(hash)) return(NA)
      refreshed = F
      table <- xfun::cache_rds({
              f <- get_file(needed_files, path=params$dir, ssh=ssh, ssh_key = params$ssh_key)
              refreshed <- ifelse(is.na(f), NA, T)
              message(paste("Reading file", f))
              read.table(f, sep=";", header=T)
      }, hash = list(hash))
      return(refreshed)
  })
}
```

```{r check_table}
# needed_file: the file I want to check if it has changed
# table: the data from needed_file
# output_refreshed: vaiable indicating if 

needed_file <- "output.csv"

hash <- get_mtime(needed_file, path=params$dir, ssh=ssh, ssh_key=params$ssh_key)

if(is.na(hash)) {
  warning("could not get hash on file")
  knitr::kable(unlist(p))
}

output_refreshed = F
      
table <- xfun::cache_rds({
  f <- get_file(needed_file, path=params$dir, ssh=ssh, ssh_key = params$ssh_key)
  output_refreshed <- ifelse(is.na(f), NA, T)
  message(paste("Reading file", f))
  table <- read.table(f, sep=";", header=T)
  if(!is.na(ssh)) file.remove(f)
  table
}, hash = list(hash), rerun = params$force)

```

<!--output_refreshed = `r output_refreshed`-->

```{r transforming_table}
table_long <- xfun::cache_rds({
  message("table_long generated")
  table |> 
    select( !starts_with("no_A", ignore.case = F)) |> 
    pivot_longer(cols=no_par:mean_a_enz2, names_to=c("what", "type"), values_to = "val", names_pattern = "(.*)_(.*)")
}, rerun = output_refreshed )
```


```{r transforming_table2}
table_A <- xfun::cache_rds({
  message("table_A generated")
  table |> 
    select( time:sd_M, starts_with("no_A", ignore.case = F)) |>
    pivot_longer(cols=starts_with("no_A", ignore.case = F), names_to= "type", values_to = "number", names_prefix = "no_")
}, rerun = output_refreshed)

```



# Properties of enzyme types

```{r plot_everything, eval=output_refreshed, fig.show='hide'}
ggplot(table_long, aes(x=time, y=val))+
  geom_line(aes(color=type))+
  facet_wrap(vars(what), scales = "free")#+
  #labs(caption = Sys.time())
```

![](`r knitr::fig_chunk('plot_everything', 'png')`)

# Cell diagnostics

```{r, echo=F, eval=F}
ggplot(table, aes(x=time, y=no_alive, color=replicators))+
   geom_point()+
   labs(x="Time [generations]", y="Number of vesicles with an active metabolism")
```

```{r plot_M, eval=output_refreshed, fig.show='hide'}
ggplot(table, aes(x=time, y=mean_M ))+
  geom_line()+
  geom_errorbar(aes(ymin=mean_M - sd_M/sqrt(300), ymax=mean_M + sd_M/sqrt(300)))
```

![](`r knitr::fig_chunk('plot_M', 'png')`)

# Relicators by promiscuity levels

```{r plot_noA, eval=output_refreshed, fig.show='hide'}
ggplot( table_A, aes(x=time, y= number, color=type))+
  geom_line()
```

![](`r knitr::fig_chunk('plot_noA', 'png')`)
